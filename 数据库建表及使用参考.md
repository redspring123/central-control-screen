<!-- # 所需要的库

user（用户id, 账号，密码,用户名称，手机号码， 创建时间）

用户身体数据（身体数据id，年龄，性别，身高，体重，体脂率等用户画像内容）

用户和身体数据关联表（用户id，身体数据id）如果需要在添加，或者直接合并user和用户身体数据

运动健康数据（健康数据id，步数，热量，睡眠，压力，心率，血压，血氧，体温）

用户和运动健康数据关联表（）如果需要再添加

房屋数据表（房屋数据id，家庭能耗，家庭网络上行和下行速度，光照，二氧化碳，）

用户房屋关联表（）如果需要再添加

健康宣讲内容（宣讲内容id，宣讲内容文档）我们需要根据用户画像（用AI）计算出可以推送的内容

在线问诊医生表（服务id，医生姓名，医院名称，科室名称，医生简介）（后续可以根据医生简介来对用户提供个性化
推送，比如根据简介与用户画像生成优先级，然后根据优先级来排序在线问诊中的医生顺序） -->

# 鸿蒙本地关系型数据库设计（单库多表，满足 ER & 第三范式）

## 0. 总体方案
- 使用鸿蒙内置关系型数据库（`@kit.ArkData` 的 `relationalStore`），单库多表。
- 数据库文件名：`AppData.db`，安全级别建议 `S1`（如有敏感数据可提升至 S2）。
- 以用户为中心的 ER 关系：用户 ↔ 画像/健康/房屋/内容/医生，满足 3NF（非主属性仅依赖主键）。

## 1. 表清单（主键/外键/用途）
- `user`：用户账户主表。
- `user_profile`：用户画像（年龄、性别、身高、体重、体脂等）。
- `health_daily`：按日健康聚合（步数、热量、睡眠、压力、心率、血压、血氧、体温）。
- `health_measurement`：单次健康测量明细（血压、血氧、体温等原始记录）。
- `house_metrics`：家庭/房屋环境与能耗数据。
- `health_content`：健康宣讲/内容，用于个性化推送。
- `doctor`：在线问诊医生信息。
- （可选）`recommendation`：用户画像→内容/医生推荐日志或优先级缓存。

## 2. 建表 SQL（SQLite 兼容，供 `executeSql` 使用）
```sql
-- 1) 用户
CREATE TABLE IF NOT EXISTS user (
	id INTEGER PRIMARY KEY AUTOINCREMENT,
	account TEXT NOT NULL UNIQUE,
	password TEXT NOT NULL,
	name TEXT,
	phone TEXT,
	created_at TEXT NOT NULL DEFAULT (datetime('now'))
);
CREATE INDEX IF NOT EXISTS idx_user_account ON user(account);

-- 2) 用户画像
CREATE TABLE IF NOT EXISTS user_profile (
	id INTEGER PRIMARY KEY AUTOINCREMENT,
	user_id INTEGER NOT NULL,
	age INTEGER,
	gender TEXT,             -- M/F/Other
	height_cm REAL,
	weight_kg REAL,
	body_fat_pct REAL,
	created_at TEXT NOT NULL DEFAULT (datetime('now')),
	updated_at TEXT,
	FOREIGN KEY(user_id) REFERENCES user(id) ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS idx_profile_user ON user_profile(user_id);

-- 3) 每日健康聚合
CREATE TABLE IF NOT EXISTS health_daily (
	id INTEGER PRIMARY KEY AUTOINCREMENT,
	user_id INTEGER NOT NULL,
	date TEXT NOT NULL,          -- YYYY-MM-DD
	steps INTEGER DEFAULT 0,
	calories REAL DEFAULT 0,
	sleep_total REAL DEFAULT 0,  -- 小时
	stress INTEGER,
	heart_rate_rest INTEGER,
	bp_sys INTEGER,
	bp_dia INTEGER,
	spo2 INTEGER,
	temperature REAL,
	updated_at TEXT NOT NULL DEFAULT (datetime('now')),
	UNIQUE(user_id, date),
	FOREIGN KEY(user_id) REFERENCES user(id) ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS idx_health_daily_user_date ON health_daily(user_id, date DESC);

-- 4) 健康测量明细（可存单次血压/血氧/体温等）
CREATE TABLE IF NOT EXISTS health_measurement (
	id INTEGER PRIMARY KEY AUTOINCREMENT,
	user_id INTEGER NOT NULL,
	type TEXT NOT NULL,         -- bp/spo2/temp/hr
	value1 REAL NOT NULL,       -- 如收缩压/心率/温度
	value2 REAL,                -- 如舒张压
	unit TEXT,                  -- mmHg/%/℃/bpm
	measured_at TEXT NOT NULL,  -- ISO8601
	FOREIGN KEY(user_id) REFERENCES user(id) ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS idx_measure_user_type_time ON health_measurement(user_id, type, measured_at DESC);

-- 5) 房屋/环境数据
CREATE TABLE IF NOT EXISTS house_metrics (
	id INTEGER PRIMARY KEY AUTOINCREMENT,
	user_id INTEGER NOT NULL,
	ts TEXT NOT NULL,             -- 时间戳/ISO8601
	energy_kwh REAL,
	net_up_mbps REAL,
	net_down_mbps REAL,
	light_lux REAL,
	co2_ppm REAL,
	updated_at TEXT,
	FOREIGN KEY(user_id) REFERENCES user(id) ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS idx_house_user_ts ON house_metrics(user_id, ts DESC);

-- 6) 健康宣讲内容
CREATE TABLE IF NOT EXISTS health_content (
	id INTEGER PRIMARY KEY AUTOINCREMENT,
	title TEXT,
	doc_url TEXT,        -- 文件或富文本地址
	tags TEXT,           -- 逗号分隔标签，便于检索
	created_at TEXT NOT NULL DEFAULT (datetime('now'))
);

-- 7) 在线问诊医生
CREATE TABLE IF NOT EXISTS doctor (
	id INTEGER PRIMARY KEY AUTOINCREMENT,
	name TEXT NOT NULL,
	hospital TEXT,
	department TEXT,
	intro TEXT,
	priority_base REAL DEFAULT 0,  -- 基础优先级，可结合画像排序
	created_at TEXT NOT NULL DEFAULT (datetime('now'))
);
CREATE INDEX IF NOT EXISTS idx_doctor_dept_priority ON doctor(department, priority_base DESC);

-- 8) 推荐日志/缓存（可选，用于画像→内容/医生推送记录）
CREATE TABLE IF NOT EXISTS recommendation (
	id INTEGER PRIMARY KEY AUTOINCREMENT,
	user_id INTEGER NOT NULL,
	target_type TEXT NOT NULL,   -- content/doctor
	target_id INTEGER NOT NULL,
	score REAL,                  -- 推荐得分
	created_at TEXT NOT NULL DEFAULT (datetime('now')),
	FOREIGN KEY(user_id) REFERENCES user(id) ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS idx_reco_user_type_score ON recommendation(user_id, target_type, score DESC);
```

## 3. 关系与 3NF 说明
- `user` 是一切业务的根实体；画像、健康、房屋、推荐均通过 `user_id` 关联，避免重复存储。
- 日聚合 (`health_daily`) 与原始测量 (`health_measurement`) 分表，防止非主属性对非键依赖。
- 房屋环境独立表，按时间序列；不混入用户个人属性，满足 3NF。
- 内容与医生信息独立表，可被推荐日志引用；不存放冗余的用户画像字段。

## 4. 使用指引（后端/ArkTS 示例）
### 4.1 初始化数据库（已完成，打开软件自动初始化）
```ts
import { relationalStore } from '@kit.ArkData';

const config: relationalStore.StoreConfig = {
	name: 'AppData.db',
	securityLevel: relationalStore.SecurityLevel.S1
};

let rdbStore: relationalStore.RdbStore | null = null;

async function initDb(context: any) {
	if (rdbStore) return;
	rdbStore = await relationalStore.getRdbStore(context, config);
	await rdbStore.executeSql(/* 将上面的建表 SQL 逐条 executeSql */);
}
```

### 4.2 插入示例
```ts
// 插入用户
await rdbStore!.insert('user', {
	account: 'demo',
	password: '***',
	name: '张三',
	phone: '13800000000'
});

// 插入每日健康数据
await rdbStore!.insert('health_daily', {
	user_id: 1,
	date: '2025-12-31',
	steps: 12345,
	calories: 420,
	sleep_total: 7.5,
	stress: 30,
	heart_rate_rest: 62,
	bp_sys: 118,
	bp_dia: 76,
	spo2: 98,
	temperature: 36.5
});

// 插入房屋数据
await rdbStore!.insert('house_metrics', {
	user_id: 1,
	ts: new Date().toISOString(),
	energy_kwh: 3.2,
	net_up_mbps: 20,
	net_down_mbps: 120,
	light_lux: 300,
	co2_ppm: 620
});
```

### 4.3 查询示例
```ts
// 查询用户某日健康数据
const p1 = new relationalStore.RdbPredicates('health_daily');
p1.equalTo('user_id', 1).and().equalTo('date', '2025-12-31');
const rs1 = await rdbStore!.query(p1);
// 使用 resultSet.get* 读取后关闭
rs1.close();

// 查询最近 7 天健康数据
const p2 = new relationalStore.RdbPredicates('health_daily');
// 这里可以在业务层计算近 7 天日期列表后用 in() 过滤
p2.equalTo('user_id', 1).orderByDesc('date').limitAs(7);
const rs2 = await rdbStore!.query(p2);
rs2.close();

// 按时间倒序查房屋数据
const p3 = new relationalStore.RdbPredicates('house_metrics');
p3.equalTo('user_id', 1).orderByDesc('ts').limitAs(50);
const rs3 = await rdbStore!.query(p3);
rs3.close();
```

### 4.4 更新/删除示例
```ts
// 更新当日健康数据
const upd = { steps: 14000, calories: 480 };
const pu = new relationalStore.RdbPredicates('health_daily');
pu.equalTo('user_id', 1).and().equalTo('date', '2025-12-31');
await rdbStore!.update(upd, pu);

// 删除某医生
const pd = new relationalStore.RdbPredicates('doctor');
pd.equalTo('id', 5);
await rdbStore!.delete(pd);
```

### 4.5 事务示例
```ts
await rdbStore!.beginTransaction();
try {
	await rdbStore!.insert('user', { account: 'u1', password: '***' });
	await rdbStore!.insert('user_profile', { user_id: 1, age: 30 });
	await rdbStore!.commit();
} catch (err) {
	await rdbStore!.rollBack();
	throw err;
}
```

## 5. 与后端对接建议
- 若有云端同步：各表增加 `updated_at` 与 `dirty/ops` 标志，使用增量拉取；或在 `recommendation` 存放推送记录。
- 密码字段请在上层加密/哈希（本地库只存密文）。
- 大文档/媒体建议存文件，表里存 URL/路径，避免库文件膨胀。
- 需要 AI 画像→内容/医生排序时，后端可根据画像计算得分写入 `recommendation`（或直接用 API 返回排序结果）。

## 6. 后续可选扩展
- 为所有高频查询字段补充索引（已给出基础索引，可按实际查询再补）。
- health_measurement 可进一步细分 type 值域（bp/spo2/temp/hr），并在业务层校验。
- house_metrics 可拆为能耗/网络/环境子表，如出现字段稀疏或写入频率差异较大。

## 7. 运动健康历史记录的存储与使用
- 原始明细用 `health_measurement`，每次测量/采样插入一行（含 `type`、`value1/2`、`measured_at`），天然保留历史。
- 按日汇总用 `health_daily`，每天更新一行（`UNIQUE(user_id, date)`），写法：先查当日有无记录，插入或 `update` 叠加统计字段。
- 查询最近 N 条/天历史：
	- 明细：`RdbPredicates('health_measurement').equalTo('user_id', 1).and().equalTo('type', 'bp').orderByDesc('measured_at').limitAs(50)`
	- 日汇总：`RdbPredicates('health_daily').equalTo('user_id', 1).orderByDesc('date').limitAs(30)`
- 若需要周/月统计：业务层从 `health_daily` 聚合；如要高效可再建派生表，但需由服务端或定时任务维护，避免破坏 3NF。

