import { RouterHelper } from '../model/RouterHelper'
import { btn } from '../model/btn'
import router from '@ohos.router';
import { HomeDataService, EnergyData, NetworkData, WeatherData } from '../model/HomeDataService';
import { AppDatabase } from 'utils';
import { HealthDataService } from 'health';
// å¼•å…¥å‘½åè·¯ç”±é¡µé¢ï¼Œç¡®ä¿è·¯ç”±æ³¨å†Œç”Ÿæ•ˆ
import 'medical/src/main/ets/pages/CallPage';
import 'health/src/main/ets/page/WellnessPage';
import 'health/src/main/ets/page/HealthAssistantPage';
import 'auth/src/main/ets/pages/ProfilePage';
import 'forum/src/main/ets/pages/ForumPage';
import { common, ConfigurationConstant } from '@kit.AbilityKit';

// 1. å®šä¹‰å¡ç‰‡åº“çš„å…ƒæ•°æ®ï¼ˆç”¨äºåœ¨æ·»åŠ åˆ—è¡¨ä¸­æ˜¾ç¤ºï¼‰
interface CardMeta {
  key: string;
  name: string;
}

// 2. å¡ç‰‡åº“ï¼ˆè¿™é‡Œå®šä¹‰äº†æ‰€æœ‰å¯èƒ½è¢«æ·»åŠ çš„å¡ç‰‡ï¼‰
const CARD_LIBRARY: CardMeta[] = [
  { key: 'energy', name: 'å®¶åº­èƒ½è€—' },
  { key: 'security', name: 'å®¶åº­å®‰é˜²' },
  { key: 'network', name: 'å®¶åº­ç½‘ç»œ' },
  { key: 'health', name: 'å±…å®¶åº·å…»' },
  { key: 'consult', name: 'åœ¨çº¿é—®è¯Š' },
  { key: 'intercom', name: 'å¯è§†å¯¹è®²' },
  { key: 'forum', name: 'å¥åº·è®ºå›' },
  { key: 'music', name: 'èƒŒæ™¯éŸ³ä¹' }, // æ–°å¢ç¤ºä¾‹
  { key: 'robot', name: 'æ‰«åœ°æœºå™¨äºº' }, // æ–°å¢ç¤ºä¾‹
  { key: 'curtain', name: 'æ™ºèƒ½çª—å¸˜' }, // æ–°å¢ç¤ºä¾‹
  { key: 'light', name: 'å…¨å±‹ç¯å…‰' }   // æ–°å¢ç¤ºä¾‹
];

@Entry
@Component
export struct MainPage {
  // === çŠ¶æ€å˜é‡ ===
  @State showHome: boolean = true;
  @State showScene: boolean = false;
  @State energyData: EnergyData = { power: 0, todayUsage: 0, carbon: 0 };
  @State networkData: NetworkData = { uploadSpeed: '0 Mbps', downloadSpeed: '0 Mbps', quality: 'è‰¯' };
  @State weatherTempText: string = '26Â°C';
  @State weatherConditionText: string = 'å¤šäº‘è½¬æ™´';
  @State weatherTipText: string = 'ä»Šæ—¥ç´«å¤–çº¿è¾ƒå¼ºï¼Œå‡ºé—¨è¯·æ³¨æ„é˜²æ™’ã€‚';
  @State weatherIcon: string = 'sun';
  @State isDarkMode: boolean = false;
  @State currentBreakpoint: string = 'md';
  private timerId: number = -1;
  private context = getContext(this) as common.UIAbilityContext;

  // === æ ¸å¿ƒé€»è¾‘ï¼šå½“å‰å±•ç¤ºçš„å¡ç‰‡ Key åˆ—è¡¨ ===
  // æ•°ç»„çš„é¡ºåºå†³å®šäº† Grid ä¸­çš„æ˜¾ç¤ºé¡ºåºã€‚é»˜è®¤æ”¾4ä¸ªã€‚
  @State displayedCards: string[] = ['energy', 'security', 'health', 'network'];

  // === å¼¹çª—æ§åˆ¶å™¨ï¼šç”¨äºæ·»åŠ å¡ç‰‡ ===
  dialogController: CustomDialogController = new CustomDialogController({
    builder: AddCardDialog({
      // ä¼ å…¥å½“å‰å·²å­˜åœ¨çš„å¡ç‰‡ï¼Œç”¨äºè¿‡æ»¤ï¼ˆä¸æ˜¾ç¤ºå·²ç»æ·»åŠ çš„ï¼‰
      currentKeys: this.displayedCards,
      // ä¼ å…¥æ·»åŠ å›è°ƒ
      onAdd: (key: string) => {
        // æ ¸å¿ƒé€»è¾‘ï¼šå¾€æ•°ç»„é‡Œ push ä¸€ä¸ª keyï¼Œç•Œé¢è‡ªåŠ¨åˆ·æ–°
        if (this.displayedCards.length < 6) {
          this.displayedCards.push(key);
        }
      }
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center,
    customStyle: true // ä½¿ç”¨è‡ªå®šä¹‰æ ·å¼ï¼Œå»æ‰é»˜è®¤ç™½è‰²èƒŒæ™¯
  });

  // å·¦ä¾§å›ºå®šæŒ‰é’®åˆ—è¡¨
  private sceneList: btn[] = [
    { key: 'btn_warm_home', icon: 'login' },
    { key: 'btn_safe_leave', icon: 'logout' },
    { key: 'btn_full_temp', icon: 'full_temp' },
    { key: 'btn_dehumidify', icon: 'dehumidify' },
    { key: 'btn_ventilation', icon: 'ventilation' },
    { key: 'btn_more_scenes', icon: 'foreground' },
    { key: 'btn_one_key_call', icon: 'ventilation' },
    { key: 'btn_sport_health', icon: 'foreground' }
  ];

  async aboutToAppear() {
    // åˆå§‹åŒ–æ•°æ®åº“
    await AppDatabase.init(this.context);
    // åˆå§‹åŒ–å¥åº·æœåŠ¡
    await HealthDataService.init(this.context);
    
    this.refreshData();
    let colorMode = this.context.config.colorMode;
    this.isDarkMode = (colorMode === ConfigurationConstant.ColorMode.COLOR_MODE_DARK);
    this.timerId = setInterval(() => { this.refreshData(); }, 3000);
  }

  aboutToDisappear() {
    if (this.timerId !== -1) clearInterval(this.timerId);
  }

  async refreshData() {
    this.energyData = await HomeDataService.getEnergyData();
    this.networkData = await HomeDataService.getNetworkData();
    const w: WeatherData = HomeDataService.getWeatherData();
    const t = Math.round(w.tempC);
    this.weatherTempText = `${isNaN(t) ? 0 : t}Â°C`;
    this.weatherConditionText = w.condition;
    this.weatherTipText = w.tip;
    this.weatherIcon = w.icon || 'sun';
  }

  toggleTheme() {
    this.isDarkMode = !this.isDarkMode;
    let applicationContext = this.context.getApplicationContext();
    applicationContext.setColorMode(this.isDarkMode ? ConfigurationConstant.ColorMode.COLOR_MODE_DARK : ConfigurationConstant.ColorMode.COLOR_MODE_LIGHT);
  }

  // =====================================================================================
  // æ ¸å¿ƒ Builder åˆ†å‘å™¨ï¼šæ ¹æ® Key å†³å®šæ¸²æŸ“å“ªä¸ªå¡ç‰‡
  // è¿™å°±æ˜¯ä½ çš„â€œå¡ç‰‡åº“â€çš„å®ä½“åŒ–è¿‡ç¨‹
  // =====================================================================================
  @Builder RenderCardByKey(key: string) {
    if (key === 'energy') {
      this.EnergyCard()
    } else if (key === 'security') {
      this.SecurityCard()
    } else if (key === 'network') {
      this.NetworkCard()
    } else if (key === 'intercom') {
      this.IntercomCard()
    } else if (key === 'consult') {
      // ä½¿ç”¨ç™¾åˆ†æ¯” '35%' ä»£æ›¿å›ºå®šå°ºå¯¸ï¼Œé€‚é…ä¸åŒå±å¹•
      this.InfoCardBuilder($r('app.string.card_consult_title'), $r('app.string.card_consult_time'), 'æœåŠ¡ä¸­', $r('app.media.video_call'), '35%', true, 'card_consult', Color.Green)
    } else if (key === 'health') {
      // ä½¿ç”¨ç™¾åˆ†æ¯” '50%' ä»£æ›¿å›ºå®šå°ºå¯¸ '100fp'
      this.InfoCardBuilder($r('app.string.card_health_title'), $r('app.string.card_health_sleep'), 'ç¡çœ ä¼˜', $r('app.media.sleep_quality'), '50%', true, 'card_health')
    }
    // ğŸ†• æ–°å¢ï¼šå¥åº·è®ºå›å¡ç‰‡
    else if (key === 'forum') {
      this.InfoCardBuilder(
        $r('app.string.forum_title'),                  // æ ‡é¢˜
        'ä»Šæ—¥çƒ­å¸–: 12',              // å‰¯æ ‡é¢˜ (å¯ä»¥ç»‘å®šåŠ¨æ€å˜é‡)
        'å»äº¤æµ',                    // çŠ¶æ€/æ“ä½œæ–‡å­—
        $r('app.media.ic_public_message'), // ğŸ†• è¯·ç¡®ä¿ä½ æœ‰è¿™ä¸ªå›¾æ ‡ï¼Œæˆ–è€…ä½¿ç”¨ $r('app.media.ic_forum')
        '45%',                       // å›¾æ ‡å¤§å°
        true,                        // å¯ç‚¹å‡»
        'HealthForumPage'            // ğŸš€ è·³è½¬è·¯ç”±åç§° (éœ€ä¸ ForumPage çš„ @Entry routeName ä¸€è‡´)
      )
    }else {
      // é»˜è®¤/å…¶ä»–æœªå®ç°çš„å¡ç‰‡å ä½
      this.PlaceholderCard(key)
    }
  }

  // =====================================================================================
  // å…·ä½“å¡ç‰‡å®ç° (ä½ çš„ç§¯æœ¨)
  // =====================================================================================

  // 1. èƒ½è€—å¡ç‰‡
  @Builder EnergyCard() {
    Column({ space: 5 }) {
      Text($r('app.string.card_energy_title')).fontSize($r('app.float.font_size_large')).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_white'))
      Text(`${this.energyData.todayUsage} kWh`).fontSize($r('app.float.font_size_xlarge')).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_white'))
      Text($r('app.string.card_energy_today')).fontSize($r('app.float.font_size_small')).fontColor($r('app.color.text_gray'))
      Text(`æœ¬æœˆç¢³æ’: ${this.energyData.carbon} kg`).fontSize($r('app.float.font_size_small')).fontColor($r('app.color.text_gray'))
    }
    .width('100%').height('100%')
    .alignItems(HorizontalAlign.Center).justifyContent(FlexAlign.Center) // æ”¹ä¸ºå±…ä¸­
  }

  // 2. å®‰é˜²å¡ç‰‡
  @Builder SecurityCard() {
    Column({ space: 5 }) {
      Text($r('app.string.card_security_title')).fontSize($r('app.float.font_size_large')).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_white'))
      Text($r('app.string.card_security_status')).fontSize($r('app.float.font_size_xlarge')).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_red'))
      Row({ space: 20 }) { // å¢åŠ é—´è·
        Image($r('app.media.alarm_active')).width(32).height(32).fillColor('#4CAF50') // å¢å¤§å›¾æ ‡
        Image($r('app.media.alarm_exit')).width(32).height(32).fillColor('#F44336') // å¢å¤§å›¾æ ‡
      }.margin({ top: 10 })
    }
    .width('100%').height('100%')
    .alignItems(HorizontalAlign.Center).justifyContent(FlexAlign.Center) // æ”¹ä¸ºå±…ä¸­
  }

  // 3. ç½‘ç»œå¡ç‰‡
  @Builder NetworkCard() {
    Row() {
      Column() {
        Text($r('app.string.card_network_title')).fontSize($r('app.float.font_size_large')).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_white'))
        Text(this.networkData.quality).fontSize($r('app.float.font_size_large')).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_white'))
        Text(`â†‘ ${this.networkData.uploadSpeed}`).fontSize(12).fontColor($r('app.color.text_gray'))
        Text(`â†“ ${this.networkData.downloadSpeed}`).fontSize(12).fontColor($r('app.color.text_gray'))
      }.alignItems(HorizontalAlign.Start) // ç½‘ç»œå¡ç‰‡ä¿æŒå·¦å¯¹é½å¯èƒ½æ›´å¥½çœ‹ï¼Œæˆ–è€…ä¹Ÿæ”¹å±…ä¸­ï¼Ÿè¿™é‡Œå…ˆä¿æŒå·¦å¯¹é½ï¼Œé…åˆå³ä¾§å¤§å›¾æ ‡
      Blank()
      Image($r('app.media.network_speed')).width(48).height(48).fillColor('#ff379ee0') // å¢å¤§å›¾æ ‡
    }
    .width('100%').height('100%')
    .alignItems(VerticalAlign.Center)
    .padding({ left: 10, right: 10 }) // å¢åŠ å†…è¾¹è·é˜²æ­¢è´´è¾¹
  }

  // 4. å¯è§†å¯¹è®²
  @Builder IntercomCard() {
    Column({space: 10}) {
      Text($r('app.string.card_intercom_title')).fontSize($r('app.float.font_size_large')).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_white'))
      Row({space: 20}) {
        Column() { Image($r('app.media.door_intercom')).width(32).height(32); Text("å¯¹è®²").fontSize(12).fontColor(Color.White).margin({top:5}) }
        Column() { Image($r('app.media.camera_monitor')).width(32).height(32); Text("ç›‘æ§").fontSize(12).fontColor(Color.White).margin({top:5}) }
      }
    }
    .width('100%').height('100%')
    .alignItems(HorizontalAlign.Center).justifyContent(FlexAlign.Center) // æ”¹ä¸ºå±…ä¸­
  }

  // 5. é€šç”¨å¡ç‰‡
  @Builder InfoCardBuilder(title: Resource, subText: Resource | string, valueText: string, bgIcon: Resource | null, bgIconSize: string | number | null, isClickable: boolean, jumpKey?: string, iconColor?: ResourceColor) {
    Row() {
      Column() {
        Text(title).fontSize($r('app.float.font_size_large')).fontColor($r('app.color.text_white')).fontWeight(FontWeight.Bold)
        Text(valueText).fontSize($r('app.float.font_size_large')).fontColor($r('app.color.text_white')).fontWeight(FontWeight.Bold).margin({ top: 5, bottom: 2 })
        if (subText) Text(subText).fontSize($r('app.float.font_size_small')).fontColor($r('app.color.text_gray'))
      }.layoutWeight(1).height('100%').alignItems(HorizontalAlign.Start).justifyContent(FlexAlign.Center)
      if (bgIcon) {
        // ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„å°ºå¯¸ï¼Œå¦åˆ™é»˜è®¤ 48
        Image(bgIcon)
          .width(bgIconSize ? bgIconSize : 48)
          .height(bgIconSize ? bgIconSize : 48)
          .objectFit(ImageFit.Contain)
          .fillColor(iconColor)
      }
    }.width('100%').height('100%')
    .padding({ left: 10, right: 5 }) // å¢åŠ å†…è¾¹è·
    .onClick(() => { if (isClickable && jumpKey) RouterHelper.jump(jumpKey); })
  }

  // 6. å ä½å¡ç‰‡ï¼ˆç”¨äºæœªå®ç°çš„ï¼‰
  @Builder PlaceholderCard(name: string) {
    Column() {
      Text(name).fontSize(16).fontWeight(FontWeight.Bold).fontColor(Color.White)
      Text("æš‚æœªå¼€å‘").fontSize(12).fontColor(Color.Gray)
    }.width('100%').height('100%').justifyContent(FlexAlign.Center)
  }


  // =====================================================================================
  // UI å¸ƒå±€
  // =====================================================================================
  build() {
    Column() {
      // 1. é¡¶éƒ¨æ  (ç®€åŒ–)
      Row() {
        // ä¸ªäººä¿¡æ¯å…¥å£
        Image($r('app.media.user_icon'))
          .width(24).height(24)
          .margin({ right: 10 })
          .onClick(() => {
            router.pushNamedRoute({ name: 'ProfilePage' });
          })

        Blank()
        Row({ space: 15 }) {
          Image($r('app.media.home_icon')).width(24).height(24).fillColor(Color.White).opacity(this.showHome ? 1 : 0.5)
          Image($r('app.media.sofa_icon')).width(24).height(24).fillColor(Color.White).opacity(this.showScene ? 1 : 0.5)
          Button() { Image(this.isDarkMode ? $r('app.media.ic_sun') : $r('app.media.ic_moon')).width(24).height(24).fillColor(Color.White) }
          .type(ButtonType.Normal).backgroundColor(Color.Transparent)
          .onClick(() => this.toggleTheme())

          // æ¨¡æ‹Ÿæ•°æ®æŒ‰é’®
          Button("æ¨¡æ‹Ÿæ•°æ®")
            .fontSize(12)
            .height(28)
            .backgroundColor('#40FFFFFF')
            .fontColor(Color.White)
            .borderRadius(14)
            .onClick(async () => {
              // 1. æ¨¡æ‹Ÿå†™å…¥æ•°æ®
              await HomeDataService.simulateData();
              await HealthDataService.simulateData();
              
              // 2. åˆ·æ–°ç•Œé¢
              this.refreshData();
              
              // 3. æç¤ºç”¨æˆ·
              // promptAction.showToast({ message: 'æ•°æ®å·²æ›´æ–°' }); // éœ€è¦ import promptAction
            })

        }.margin({ left: 20 })
      }.backgroundColor($r('app.color.top')).width('100%').padding(15)

      // 2. ä¸»ä½“å†…å®¹ï¼šä½¿ç”¨ GridRow å®ç°å“åº”å¼å¸ƒå±€ (æ‰‹æœºç«–æ’ï¼Œå¹³æ¿æ¨ªæ’)
      Scroll() {
        GridRow({
          columns: 12,
          gutter: { x: 15, y: 15 }, // æ°´å¹³å’Œå‚ç›´é—´è·
          breakpoints: { value: ["600vp", "840vp"], reference: BreakpointsReference.WindowSize }
        }) {

          // --- A. å·¦ä¾§ï¼šåœºæ™¯æŒ‰é’® + å¤©æ°” ---
          // sm(æ‰‹æœº): å æ»¡12åˆ— (æ¢è¡Œæ˜¾ç¤º)
          // md(å¹³æ¿): å 4åˆ— (å·¦ä¾§æ˜¾ç¤º)
          GridCol({ span: { sm: 12, md: 4, lg: 3 } }) {
            Column({ space: 10 }) { // å¢åŠ é—´è·
              // Grid åœºæ™¯æŒ‰é’®
              Grid() {
                ForEach(this.sceneList, (item: btn) => {
                  GridItem() {
                    Button() {
                      Row() {
                        Column() { Image($r(`app.media.${item.icon}`)).width(20).height(20) }
                        .width(36).height(36).backgroundColor($r('app.color.bg_icon_container')).borderRadius(10).justifyContent(FlexAlign.Center).margin({ right: 10 })
                        Text($r(`app.string.${item.key}`)).fontSize(14).fontColor(Color.White).layoutWeight(1)
                      }.width('100%').padding(8)
                    }
                    .type(ButtonType.Normal)
                    .backgroundColor(this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.25)')
                    .backdropBlur(20).border({ width: 0.5, color: 'rgba(255, 255, 255, 0.2)' }).borderRadius(12)
                    .width('100%').height(60)
                    .onClick(() => RouterHelper.jump(item.key))
                  }
                }, (item: btn) => item.key)
              }
              .columnsTemplate('1fr 1fr')
              .rowsGap(10).columnsGap(10)
              .height(this.showHome ? (this.currentBreakpoint === 'sm' ? 280 : 280) : 0) // ç®€å•é€‚é…

              // å¤©æ°”å¡ç‰‡
              Row() {
                Image($r(`app.media.ic_${this.weatherIcon}`)).width(40).height(40).margin({ right: 10, left: 10 })
                Column() {
                  Text(this.weatherTempText).fontSize(24).fontWeight(FontWeight.Bold).fontColor(Color.White)
                  Text(this.weatherConditionText).fontSize(12).fontColor(Color.White).opacity(0.8)
                }.alignItems(HorizontalAlign.Start)
                Blank()
                Text(this.weatherTipText).fontSize(12).fontColor(Color.White).opacity(0.8).maxLines(2).textOverflow({overflow:TextOverflow.Ellipsis}).width('40%').margin({right:10})
              }
              .width('100%').height(80) // å›ºå®šé«˜åº¦
              .backgroundColor(this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.25)')
              .backdropBlur(20).border({ width: 0.5, color: 'rgba(255, 255, 255, 0.2)' }).borderRadius(12)

              // AI å¥åº·åŠ©æ‰‹å…¥å£
              Row() {
                SymbolGlyph($r('sys.symbol.heart_fill'))//ç³»ç»Ÿå†…ç½®å›¾æ ‡
                  .fontSize(32)
                  .width(40)
                  .height(40)
                  .margin({ right: 10, left: 10 })
                  .fontColor([Color.Red])
                Column() {
                  Text("å¥åº·åŠ©æ‰‹").fontSize(18).fontWeight(FontWeight.Bold).fontColor(Color.White)
                  Text("AI æ™ºèƒ½åˆ†æ").fontSize(12).fontColor(Color.White).opacity(0.8)
                }.alignItems(HorizontalAlign.Start)
                Blank()
              }
              .width('100%').height(80)
              .backgroundColor(this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.25)')
              .backdropBlur(20).border({ width: 0.5, color: 'rgba(255, 255, 255, 0.2)' }).borderRadius(12)
              .onClick(() => {
                router.pushNamedRoute({ name: 'HealthAssistantPage' });
              })
            }
          }

          // --- B. å³ä¾§ï¼šå¯å¢åˆ çš„å¡ç‰‡ Grid ---
          // sm(æ‰‹æœº): å æ»¡12åˆ—
          // md(å¹³æ¿): å 8åˆ—
          GridCol({ span: { sm: 12, md: 8, lg: 9 } }) {
            Grid() {
              // 1. æ¸²æŸ“å·²æ·»åŠ çš„å¡ç‰‡
              ForEach(this.displayedCards, (key: string, index: number) => {
                GridItem() {
                  Stack({ alignContent: Alignment.TopEnd }) {
                    // (1) å¡ç‰‡å†…å®¹ä¸»ä½“
                    Column() {
                      this.RenderCardByKey(key)
                    }
                    .width('100%').height('100%')
                    .padding(15)

                    // (2) åˆ é™¤æŒ‰é’®
                    Button() {
                      Image($r('app.media.ic_public_cancel'))
                        .width(16).height(16)
                        .fillColor('rgba(255,255,255,0.6)')
                    }
                    .type(ButtonType.Circle)
                    .backgroundColor('rgba(0,0,0,0.2)')
                    .width(24).height(24)
                    .margin({ top: 5, right: 5 })
                    .onClick(() => {
                      this.displayedCards.splice(index, 1);
                    })
                  }
                  .backgroundColor(this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.25)')
                  .backdropBlur(20)
                  .border({ width: 0.5, color: 'rgba(255, 255, 255, 0.2)' })
                  .borderRadius(16)
                  .width('100%')
                  .height(this.currentBreakpoint === 'sm' ? 180 : '100%') // æ‰‹æœºæ¨¡å¼ä¸‹ç»™ä¸ªå›ºå®šé«˜åº¦ï¼Œå¹³æ¿æ¨¡å¼ä¸‹æ’‘æ»¡
                }
              }, (key: string) => key)

              // 2. æ¸²æŸ“â€œæ·»åŠ â€æŒ‰é’®
              if (this.displayedCards.length < 6) {
                GridItem() {
                  Button() {
                    Column() {
                      Text("+").fontSize(40).fontColor('rgba(255,255,255,0.5)').fontWeight(FontWeight.Lighter)
                      Text("æ·»åŠ å¡ç‰‡").fontSize(12).fontColor('rgba(255,255,255,0.5)')
                    }
                  }
                  .type(ButtonType.Normal)
                  .backgroundColor('rgba(255, 255, 255, 0.05)')
                  .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)', style: BorderStyle.Dashed })
                  .borderRadius(16)
                  .width('100%')
                  .height(this.currentBreakpoint === 'sm' ? 180 : '100%')
                  .onClick(() => {
                    this.dialogController.open()
                  })
                }
              }

            }
            .columnsTemplate('1fr 1fr')
            .rowsTemplate(this.currentBreakpoint === 'sm' ? undefined : '1fr 1fr 1fr') // æ‰‹æœºæ¨¡å¼ä¸‹ä¸å›ºå®šè¡Œæ•°ï¼Œå…è®¸æ»šåŠ¨
            .rowsGap(15)
            .columnsGap(15)
            .height(this.currentBreakpoint === 'sm' ? undefined : '100%') // æ‰‹æœºæ¨¡å¼ä¸‹é«˜åº¦è‡ªé€‚åº”
          }

        }
        .onBreakpointChange((breakpoint: string) => {
          this.currentBreakpoint = breakpoint;
        })
        .width('100%').padding(15)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .align(Alignment.TopStart)
    }
    .width('100%').height('100%')
    .backgroundColor($r('app.color.bg_page'))
    .backgroundImage($r('app.media.bg')).backgroundImageSize(ImageSize.Cover)
  }
}

// =====================================================================================
// åº•éƒ¨å¼¹çª—ï¼šå¡ç‰‡åº“åˆ—è¡¨ (æ·»åŠ å¡ç‰‡)
// =====================================================================================
@CustomDialog
struct AddCardDialog {
  controller: CustomDialogController
  currentKeys: string[] = [] // æ¥æ”¶å·²å­˜åœ¨çš„ key
  onAdd: (key: string) => void = () => {}

  build() {
    Column() {
      Text("æ·»åŠ å¡ç‰‡åˆ°æ¡Œé¢")
        .fontSize(18).fontWeight(FontWeight.Bold).fontColor(Color.Black)
        .margin({ top: 20, bottom: 10 })
        .width('100%').textAlign(TextAlign.Start).padding({left: 20})

      Grid() {
        // éå†æ‰€æœ‰å¯èƒ½çš„å¡ç‰‡
        ForEach(CARD_LIBRARY, (item: CardMeta) => {
          GridItem() {
            Button() {
              Column({space: 5}) {
                // è¿™é‡Œå¯ä»¥ç”¨æ›´ä¸°å¯Œçš„å›¾æ ‡
                Image($r('app.media.home_icon')) // æš‚æ—¶ç”¨é€šç”¨å›¾æ ‡ï¼Œå®é™…å¯ç”¨ item.key æ˜ å°„
                  .width(24).height(24).fillColor('#007DFF')
                Text(item.name)
                  .fontSize(14).fontColor(Color.Black)
              }
            }
            .type(ButtonType.Normal)
            .width('100%').height(80)
            .backgroundColor('#F5F7FA')
            .borderRadius(12)
            .opacity(this.currentKeys.includes(item.key) ? 0.4 : 1) // å¦‚æœå·²æ·»åŠ ï¼Œå˜ç°
            .enabled(!this.currentKeys.includes(item.key)) // å¦‚æœå·²æ·»åŠ ï¼Œç¦ç”¨
            .onClick(() => {
              this.onAdd(item.key)
              this.controller.close()
            })
          }
        })
      }
      .columnsTemplate('1fr 1fr 1fr') // 3åˆ—
      .rowsGap(10).columnsGap(10)
      .padding(15)
      .height(200)

      Button("å–æ¶ˆ")
        .fontColor(Color.Gray)
        .backgroundColor(Color.Transparent)
        .onClick(() => this.controller.close())
        .margin({ bottom: 10 })
    }
    .width('90%')
    .backgroundColor(Color.White)
    .borderRadius(24)
  }
}
