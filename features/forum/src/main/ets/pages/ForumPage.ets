import { ForumService } from '../service/ForumService';
import { ForumPost, UserInfo, PostDetailData, ProfileData, Comment, ApiResponse } from '../model/ForumModel';
import { promptAction } from '@kit.ArkUI';
import { picker, fileIo as fs } from '@kit.CoreFileKit';
import { request } from '@kit.BasicServicesKit';
import { common } from '@kit.AbilityKit';

// ğŸ”´ ç¡®è®¤ IP åœ°å€
// const DOMAIN = 'http://172.26.117.216:8000';
const DOMAIN = 'http://172.26.23.157:8000';

// âš¡ï¸ å›¾ç‰‡ URL å¤„ç†å·¥å…· (å¼ºåŠ›ä¿®å¤ç‰ˆ)
function getImageUrl(url: string): string {
  if (!url) return '';

  // 1. å¦‚æœæ˜¯ Base64 æ•°æ®ï¼Œç›´æ¥è¿”å›
  if (url.startsWith('data:')) return url;

  // 2. æ ¸å¿ƒé€»è¾‘ï¼šåªè¦ URL ä¸­åŒ…å« "uploads/"ï¼Œå°±å¼ºåˆ¶æ›¿æ¢å‰é¢çš„åŸŸå/IP
  // è¿™èƒ½è§£å†³ IP å˜åŠ¨ã€localhostã€10.0.2.2 ç­‰æ‰€æœ‰å†å²é—ç•™é—®é¢˜
  const keyword = 'uploads/';
  const index = url.indexOf(keyword);
  
  if (index >= 0) {
    // æå–ä» uploads/ å¼€å§‹çš„è·¯å¾„ (ä¾‹å¦‚ "uploads/abc.jpg")
    let relativePath = url.substring(index);
    return `${DOMAIN}/${relativePath}`;
  }

  // 3. å¦‚æœä¸åŒ…å« uploads/ ä½†å·²ç»æ˜¯ http å¼€å¤´ï¼ˆå¤–é“¾ï¼‰ï¼Œåˆ™ä¿ç•™
  if (url.startsWith('http')) return url;

  // 4. å‰©ä¸‹çš„æƒ…å†µè®¤ä¸ºæ˜¯ç›¸å¯¹è·¯å¾„æˆ–çº¯æ–‡ä»¶å
  let cleanPath = url;
  // å»é™¤å¼€å¤´çš„ /
  while (cleanPath.startsWith('/')) {
    cleanPath = cleanPath.substring(1);
  }

  // å¦‚æœçœ‹èµ·æ¥åƒæ–‡ä»¶åï¼Œè¡¥å…¨ uploads/
  if (!cleanPath.includes('/') && (cleanPath.endsWith('.jpg') || cleanPath.endsWith('.png') || cleanPath.endsWith('.jpeg'))) {
    cleanPath = `uploads/${cleanPath}`;
  }

  return `${DOMAIN}/${cleanPath}`;
}

class PostParams {
  id: number = 0
  constructor(id: number) { this.id = id }
}

class PublishParams {
  postId?: number
  title?: string
  content?: string
  tags?: string
  images?: string[]
}

class SearchParams {
  keyword: string = ''
  constructor(keyword: string) { this.keyword = keyword }
}

AppStorage.setOrCreate('currentUserId', 0);
AppStorage.setOrCreate('refreshFeed', 0);

@Entry({ routeName: 'HealthForumPage' })
@Component
export struct ForumPage {
  @Provide('pageStack') pageStack: NavPathStack = new NavPathStack();
  @State currentIndex: number = 0;
  @StorageLink('currentUserId') currentUserId: number = 0;

  build() {
    Navigation(this.pageStack) {
      Tabs({ barPosition: BarPosition.End, index: this.currentIndex }) {
        TabContent() { HomePage() }.tabBar(this.TabBuilder('é¦–é¡µ', 0, $r('app.media.ic_public_home')))
        TabContent() {}.tabBar(this.AddBtnBuilder())
        TabContent() {
          if (this.currentUserId > 0) ProfileView({ userId: this.currentUserId, isSelf: true })
          else LoginView()
        }.tabBar(this.TabBuilder('æˆ‘çš„', 2, $r('app.media.ic_public_contacts')))
      }
      .onChange((index) => {
        if (index === 1) {
          if (this.currentUserId === 0) {
            promptAction.showToast({message: 'è¯·å…ˆç™»å½•'});
            this.currentIndex = 2;
          } else {
            // ä¿®å¤ï¼šä½¿ç”¨ setTimeout ç¡®ä¿çŠ¶æ€æ›´æ–°ä¸ä¼šå†²çªï¼Œå¹¶å¼ºåˆ¶é‡ç½® currentIndex
            setTimeout(() => {
              this.pageStack.pushPath({ name: 'PublishPage' });
              this.currentIndex = 0;
            }, 10);
          }
        } else {
          this.currentIndex = index;
        }
      })
      .barHeight(56)
    }
    .mode(NavigationMode.Stack)
    .navDestination(this.PagesMap)
    .hideTitleBar(true)
  }

  @Builder PagesMap(name: string, param: object) {
    if (name === 'PostDetail') PostDetailView({ postId: (param as PostParams).id })
    else if (name === 'PublishPage') {
      PublishView({
        editPostId: (param as PublishParams)?.postId || 0,
        title: (param as PublishParams)?.title || '',
        content: (param as PublishParams)?.content || '',
        tags: (param as PublishParams)?.tags || '',
        uploadedUrls: (param as PublishParams)?.images || []
      })
    }
    else if (name === 'UserProfile') ProfileView({ userId: (param as PostParams).id, isSelf: false })
    else if (name === 'SearchPage') SearchPage({ keyword: (param as SearchParams).keyword })
  }

  @Builder TabBuilder(title: string, index: number, icon: Resource) {
    Column() {
      // è¿™é‡Œçš„ fillColor å¯ä»¥ç•™ç€ï¼Œå› ä¸ºåº•éƒ¨ Tab å›¾æ ‡é€šå¸¸æ˜¯ç®€å•çš„ SVG
      Image(icon).width(24).fillColor(this.currentIndex === index ? $r('app.color.brand_red') : $r('app.color.text_secondary'))
      Text(title).fontSize(10).fontColor(this.currentIndex === index ? $r('app.color.brand_red') : $r('app.color.text_secondary')).margin({top:2})
    }.justifyContent(FlexAlign.Center).height('100%')
  }

  @Builder AddBtnBuilder() {
    Column() {
      Stack() {
        // èƒŒæ™¯åœ†åœˆï¼Œç¡®ä¿åœ¨ä»»ä½•æ¨¡å¼ä¸‹éƒ½æœ‰å¯¹æ¯”åº¦
        Circle().width(40).height(40).fill($r('app.color.bg_card'))
        // å›¾æ ‡
        Image($r('app.media.ic_public_add'))
          .width(38).height(38)
          .fillColor($r('app.color.brand_red'))
      }
      .margin({top: 5})
    }.height('100%').justifyContent(FlexAlign.Center)
  }
}

// ===================== é¦–é¡µ (ä¿®å¤è‡ªåŠ¨åˆ·æ–° + ç€‘å¸ƒæµ) =====================
@Component
struct HomePage {
  @Consume('pageStack') pageStack: NavPathStack;
  @State posts: ForumPost[] = [];
  @State searchText: string = '';
  @State isLoading: boolean = false; // åŠ è½½çŠ¶æ€

  @StorageProp('refreshFeed') @Watch('loadData') refreshSignal: number = 0;

  // âš¡ï¸ ä¿®å¤1ï¼šç»„ä»¶ä¸€åŠ è½½å°±æ‹‰æ•°æ®
  aboutToAppear() {
    this.loadData();
  }

  // âš¡ï¸ ä¿®å¤2ï¼šé¡µé¢æ¯æ¬¡æ˜¾ç¤ºä¹Ÿæ£€æŸ¥æ•°æ®ï¼ˆåŒé‡ä¿é™©ï¼‰
  onPageShow() {
    if (this.posts.length === 0) {
      this.loadData();
    }
  }

  async loadData() {
    this.isLoading = true;
    const res = await ForumService.getFeed(this.searchText);
    this.isLoading = false;
    if (res.success && res.data) {
      // âš¡ï¸ ä¿®å¤ï¼šé˜²æ­¢ images/tags å­—æ®µæ˜¯å­—ç¬¦ä¸²ï¼ˆåç«¯æœªè§£æ JSON çš„æƒ…å†µï¼‰
      this.posts = res.data.map(item => {
        if (typeof item.images === 'string') {
          try { item.images = JSON.parse(item.images); } catch(e) { item.images = []; }
        }
        if (typeof item.tags === 'string') {
          try { item.tags = JSON.parse(item.tags); } catch(e) { item.tags = []; }
        }
        return item;
      });
    }
  }

  // ğŸ¨ é¢œè‰²æ»¤é•œå·¥å…·ï¼šè®©é¦–é¡µçš„å°å¿ƒå¿ƒä¹Ÿèƒ½å˜çº¢
  getRedFilter() {
    return [
      0, 0, 0, 1, 0, // R = A
      0, 0, 0, 0, 0, // G = 0
      0, 0, 0, 0, 0, // B = 0
      0, 0, 0, 1, 0, // A = A
    ]
  }

  build() {
    Column() {
      Row() {
        TextInput({ placeholder: 'æœæ ‡é¢˜/æ ‡ç­¾...', text: this.searchText })
          .layoutWeight(1).backgroundColor($r('app.color.input_bg')).borderRadius(18).height(36)
          .onChange(v => this.searchText = v).onSubmit(() => this.loadData())
        Text("æœç´¢").fontColor($r('app.color.text_primary')).margin({left: 10}).onClick(() => this.loadData())
      }.padding({left: 10, right: 10, top: 5, bottom: 5})

      if (this.isLoading && this.posts.length === 0) {
        // åŠ è½½ä¸­æç¤º
        Column() { Text("åŠ è½½ä¸­...").fontColor($r('app.color.text_secondary')).margin({top: 50}) }.width('100%').height('100%')
      } else if (this.posts.length === 0) {
        // ç©ºçŠ¶æ€æç¤º
        Column() {
          Text("æš‚æ— å†…å®¹").fontColor($r('app.color.text_secondary')).margin({top: 50})
          Button("åˆ·æ–°").margin({top:10}).onClick(()=>this.loadData())
        }.width('100%').height('100%')
      } else {
        WaterFlow() {
          ForEach(this.posts, (item: ForumPost) => {
            FlowItem() {
              Column() {
                Image(item.images && item.images.length > 0 ? getImageUrl(item.images[0]) : '')
                  .width('100%').height(180).objectFit(ImageFit.Cover)
                  .borderRadius({topLeft: 8, topRight: 8}).backgroundColor('#E0E0E0')

                Text(item.title).fontSize(14).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary'))
                  .maxLines(2).textOverflow({overflow: TextOverflow.Ellipsis}).padding(8)

                Row() {
                  Row() {
                    Image(item.author_avatar ? `${DOMAIN}${item.author_avatar}` : '')
                      .width(16).height(16).borderRadius(8).backgroundColor('#ccc')
                    Text(item.author_name).fontSize(10).fontColor($r('app.color.text_secondary'))
                      .margin({left: 4}).layoutWeight(1).maxLines(1)
                  }.layoutWeight(1)

                  Row() {
                    // âš¡ï¸ é¦–é¡µç‚¹èµå˜è‰² - ä½¿ç”¨ç³»ç»Ÿ Symbol å®ç°å®å¿ƒæ•ˆæœ
                    SymbolGlyph(item.is_liked ? $r('sys.symbol.heart_fill') : $r('sys.symbol.heart'))
                      .fontSize(12)
                      .fontColor([item.is_liked ? Color.Red : $r('app.color.text_secondary')])
                    Text(` ${item.like_count}`).fontSize(10).fontColor($r('app.color.text_secondary'))
                  }
                }.padding({left: 8, right: 8, bottom: 8}).width('100%').justifyContent(FlexAlign.SpaceBetween)
              }
              .backgroundColor($r('app.color.card_bg')).borderRadius(8)
              .onClick(() => {
                this.pageStack.pushPath({ name: 'PostDetail', param: new PostParams(item.id) })
              })
            }
          })
        }
        .columnsTemplate("1fr 1fr").columnsGap(10).rowsGap(10).padding(10)
        .layoutWeight(1).backgroundColor($r('app.color.page_bg'))
      }
    }
  }
}

// ===================== å¸–å­è¯¦æƒ… (âš¡ï¸ä¿®å¤å˜è‰²é—®é¢˜) =====================
@Component
struct PostDetailView {
  @StorageLink('currentUserId') currentUserId: number = 0;
  @Consume('pageStack') pageStack: NavPathStack;
  postId: number = 0;
  @State detail: PostDetailData | null = null;
  @State isLiked: boolean = false;
  @State isFaved: boolean = false;
  @State commentText: string = '';

  aboutToAppear() { this.loadDetail(); }

  async loadDetail() {
    const res = await ForumService.getPostDetail(this.postId);
    if (res.success && res.data) {
      this.detail = res.data;
      // âš¡ï¸ ä¿®å¤ï¼šé˜²æ­¢ images/tags æ˜¯å­—ç¬¦ä¸²
      if (typeof this.detail.post.images === 'string') {
         try { this.detail.post.images = JSON.parse(this.detail.post.images); } catch(e) { this.detail.post.images = []; }
      }
      if (typeof this.detail.post.tags === 'string') {
         try { this.detail.post.tags = JSON.parse(this.detail.post.tags); } catch(e) { this.detail.post.tags = []; }
      }
      this.isLiked = (this.detail.post.is_liked ?? 0) > 0;
      this.isFaved = (this.detail.post.is_faved ?? 0) > 0;
    }
  }

  async sendComment() {
    const uid = AppStorage.get<number>('currentUserId');
    if (!uid) { promptAction.showToast({message: 'è¯·å…ˆç™»å½•'}); return; }
    if (!this.commentText) return;
    await ForumService.sendComment(uid, this.postId, this.commentText);
    this.commentText = '';
    this.loadDetail();
  }

  async toggleLike() {
    const uid = AppStorage.get<number>('currentUserId');
    if (!uid) { promptAction.showToast({message: 'è¯·å…ˆç™»å½•'}); return; }
    this.isLiked = !this.isLiked;
    await ForumService.likePost(this.postId, uid);
    AppStorage.setOrCreate('refreshFeed', Date.now());
  }

  async toggleFav() {
    const uid = AppStorage.get<number>('currentUserId');
    if (!uid) { promptAction.showToast({message: 'è¯·å…ˆç™»å½•'}); return; }
    this.isFaved = !this.isFaved;
    await ForumService.favPost(this.postId, uid);
    AppStorage.setOrCreate('refreshFeed', Date.now());
  }

  async deletePost() {
    const uid = AppStorage.get<number>('currentUserId');
    if (!uid) return;
    
    const res = await promptAction.showDialog({
      title: 'ç¡®è®¤åˆ é™¤',
      message: 'åˆ é™¤åæ— æ³•æ¢å¤ï¼Œç¡®å®šè¦åˆ é™¤å—ï¼Ÿ',
      buttons: [
        { text: 'å–æ¶ˆ', color: '#666666' },
        { text: 'åˆ é™¤', color: '#FF0000' }
      ]
    });

    if (res.index === 1) {
      const result = await ForumService.deletePost(uid, this.postId);
      if (result.success) {
        promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ' });
        AppStorage.setOrCreate('refreshFeed', Date.now());
        this.pageStack.pop();
      } else {
        promptAction.showToast({ message: result.message || 'åˆ é™¤å¤±è´¥' });
      }
    }
  }

  // ğŸ”¥ ç»ˆæå¿…æ€æŠ€ï¼šé¢œè‰²æ»¤é•œçŸ©é˜µ
  // å®ƒå¯ä»¥å¼ºåˆ¶æŠŠä»»ä½•å›¾ç‰‡çš„åƒç´ å˜æˆä½ æƒ³è¦çš„é¢œè‰²

  // çº¢è‰²æ»¤é•œ (R=1, G=0, B=0)
  // çº¢è‰²æ»¤é•œ (R=1, G=0, B=0)
  getRedFilter() {
    return [
      0, 0, 0, 1, 0, // R = A
      0, 0, 0, 0, 0, // G = 0
      0, 0, 0, 0, 0, // B = 0
      0, 0, 0, 1, 0, // A = A
    ]
  }

  // é»„è‰²/é‡‘è‰²æ»¤é•œ (R=1, G=0.8, B=0)
  getYellowFilter() {
    return [
      0, 0, 0, 1, 0, // R = A
      0, 0, 0, 0.8, 0, // G = 0.8 * A
      0, 0, 0, 0, 0, // B = 0
      0, 0, 0, 1, 0, // A = A
    ]
  }

  build() {
    NavDestination() {
      Column() {
        Row() {
          SymbolGlyph($r('sys.symbol.chevron_left'))
            .fontSize(24)
            .fontColor([Color.Black])
            .onClick(() => this.pageStack.pop())
          
          Blank()
          
          // âœï¸ ç¼–è¾‘æŒ‰é’®ï¼šåªæœ‰ä½œè€…è‡ªå·±å¯è§
          if (this.detail && this.currentUserId === this.detail.post.user_id) {
            Row() {
              Text("ç¼–è¾‘")
                .fontSize(16)
                .fontColor('#333')
                .onClick(() => {
                  const p = new PublishParams();
                  p.postId = this.detail?.post.id;
                  p.title = this.detail?.post.title;
                  p.content = this.detail?.post.content;
                  p.tags = this.detail?.post.tags ? this.detail?.post.tags.join(' ') : '';
                  p.images = this.detail?.post.images;
                  this.pageStack.pushPath({ name: 'PublishPage', param: p });
                })

              Text("åˆ é™¤")
                .fontSize(16)
                .fontColor(Color.Red)
                .margin({ left: 15 })
                .onClick(() => {
                  this.deletePost();
                })
            }
          }
        }.padding(10).width('100%')
        if (this.detail) {
          List() {
            ListItem() {
              Column() {
                Row() {
                  Image(this.detail.post.author_avatar ? `${DOMAIN}${this.detail.post.author_avatar}` : '')
                    .width(40).height(40).borderRadius(20).backgroundColor('#ccc')
                  Column() {
                    Text(this.detail.post.author_name).fontWeight(FontWeight.Bold)
                    Text('ç‚¹å‡»æŸ¥çœ‹ä¸»é¡µ').fontSize(10).fontColor('#999')
                  }.margin({left: 10}).alignItems(HorizontalAlign.Start)
                }.padding(10).width('100%').onClick(() => {
                  this.pageStack.pushPath({ name: 'UserProfile', param: new PostParams(this.detail?.post.user_id ?? 0) })
                })

                if (this.detail.post.images && this.detail.post.images.length > 0) {
                  Swiper() {
                    ForEach(this.detail.post.images, (img: string) => {
                      Image(getImageUrl(img)).width('100%').objectFit(ImageFit.Contain)
                    })
                  }
                  .height(300)
                  .indicator(true)
                  .autoPlay(false)
                }

                Text(this.detail.post.title).fontSize(20).fontWeight(FontWeight.Bold).padding(10)
                Text(this.detail.post.content).fontSize(16).padding({left: 10, right: 10})
                
                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.detail.post.tags, (tag: string) => {
                    Text('#' + tag)
                      .fontSize(14).fontColor('#007DFF')
                      .padding({ right: 10, top: 5, bottom: 5 })
                      .onClick(() => {
                        this.pageStack.pushPath({ name: 'SearchPage', param: new SearchParams(tag) })
                      })
                  })
                }.padding(10)
              }.alignItems(HorizontalAlign.Start)
            }
            ListItem() { Text(`è¯„è®º (${this.detail.comments.length})`).fontSize(14).fontColor('#999').padding(10).backgroundColor('#f5f5f5').width('100%') }
            ForEach(this.detail.comments, (c: Comment) => {
              ListItem() {
                Row() {
                  Image(c.avatar_url ? `${DOMAIN}${c.avatar_url}` : '').width(30).height(30).borderRadius(15).backgroundColor('#ccc')
                  Column() {
                    Text(c.nickname).fontSize(12).fontColor('#666')
                    Text(c.content).fontSize(14).margin({top: 2})
                  }.margin({left: 10}).alignItems(HorizontalAlign.Start)
                }.padding(10).width('100%')
              }
            })
          }.layoutWeight(1)

          Row() {
            TextInput({ placeholder: 'è¯´ç‚¹ä»€ä¹ˆ...', text: this.commentText }).layoutWeight(1).backgroundColor('#F5F5F5').borderRadius(20).onChange(v => this.commentText = v).onSubmit(() => this.sendComment())
            Text("å‘é€").fontColor('#007DFF').margin({left: 10}).onClick(() => this.sendComment())

            // â¤ï¸ ç‚¹èµ - ä½¿ç”¨ç³»ç»Ÿ Symbol
            SymbolGlyph(this.isLiked ? $r('sys.symbol.heart_fill') : $r('sys.symbol.heart'))
              .fontSize(28)
              .fontColor([this.isLiked ? Color.Red : '#999'])
              .margin({left: 15})
              .onClick(() => this.toggleLike())

            // ğŸ’› æ”¶è— - ä½¿ç”¨ç³»ç»Ÿ Symbol
            SymbolGlyph(this.isFaved ? $r('sys.symbol.star_fill') : $r('sys.symbol.star'))
              .fontSize(28)
              .fontColor([this.isFaved ? '#FFD700' : '#999'])
              .margin({left: 15})
              .onClick(() => this.toggleFav())

          }.padding(10).border({width: {top: 1}, color: '#eee'})
        }
      }
    }.hideTitleBar(true)
  }
}

// ===================== ä¸ªäººä¸»é¡µ =====================
@Component
struct ProfileView {
  @Consume('pageStack') pageStack: NavPathStack;
  userId: number = 0;
  isSelf: boolean = false;
  @State profile: ProfileData | null = null;
  @State currentTab: number = 0;
  @State errorMsg: string = '';

  @StorageProp('refreshFeed') @Watch('loadProfile') refreshSignal: number = 0;

  dialogController: CustomDialogController = new CustomDialogController({
    builder: EditProfileDialog({
      nickname: this.profile?.info.nickname,
      age: this.profile?.info.age,
      weight: this.profile?.info.weight,
      tags: this.profile?.info.health_tags,
      userId: this.userId,
      confirm: () => { this.loadProfile(); }
    }),
    autoCancel: true
  })

  // âš¡ï¸ ä¿®å¤ï¼šä¸»åŠ¨åŠ è½½
  aboutToAppear() { this.loadProfile(); }
  onPageShow() { this.loadProfile(); }

  async loadProfile() {
    const res = await ForumService.getProfile(this.userId);
    if (res.success && res.data) {
      this.profile = res.data;
      // âš¡ï¸ ä¿®å¤ï¼šéå†ä½œå“ã€ç‚¹èµã€æ”¶è—åˆ—è¡¨ï¼Œå¤„ç† images å­—æ®µ
      const fixImages = (list: ForumPost[]) => {
        return list.map(item => {
          if (typeof item.images === 'string') {
            try { item.images = JSON.parse(item.images); } catch(e) { item.images = []; }
          }
          return item;
        });
      };
      this.profile.works = fixImages(this.profile.works);
      this.profile.likes = fixImages(this.profile.likes);
      this.profile.favs = fixImages(this.profile.favs);

      this.errorMsg = '';
    } else {
      this.errorMsg = res.message || 'åŠ è½½å¤±è´¥';
    }
  }

  build() {
    NavDestination() {
      Column() {
        if (this.errorMsg) {
          Text(this.errorMsg).margin({top:50}).fontColor(Color.Red).onClick(()=>this.loadProfile())
        } else if (this.profile) {
          Row() {
            if (!this.isSelf) Image($r('app.media.icon_back')).width(24).onClick(() => this.pageStack.pop())
            Blank()
            if (this.isSelf) {
              Button("é€€å‡º").fontColor(Color.Red).backgroundColor(Color.Transparent).onClick(() => { AppStorage.setOrCreate('currentUserId', 0); })
            }
          }.width('100%').padding(10)

          Row() {
            Image(this.profile.info.avatar_url ? `${DOMAIN}${this.profile.info.avatar_url}` : '')
              .width(80).height(80).borderRadius(40).backgroundColor('#eee')
            Column() {
              Text(this.profile.info.nickname).fontSize(22).fontWeight(FontWeight.Bold)
              Text(`ID: ${this.profile.info.id}`).fontSize(12).fontColor('#999')
              Text(`æ ‡ç­¾: ${this.profile.info.health_tags || 'æ— '}`).fontSize(12).fontColor('#FF2442').margin({top: 5})
            }.alignItems(HorizontalAlign.Start).margin({left: 20})
            Blank()
            if (this.isSelf) {
              Button("ç¼–è¾‘èµ„æ–™").height(28).fontSize(12).backgroundColor('#eee').fontColor('#333').onClick(() => this.dialogController.open())
            }
          }.padding(20).width('100%')

          Row() {
            this.TabItem("ä½œå“", 0)
            this.TabItem("èµè¿‡", 1)
            this.TabItem("æ”¶è—", 2)
          }.width('100%').justifyContent(FlexAlign.SpaceAround).padding(10).border({width: {bottom: 1}, color: '#eee'})

          List() {
            ForEach(this.currentTab === 0 ? this.profile.works : (this.currentTab === 1 ? this.profile.likes : this.profile.favs), (item: ForumPost) => {
              ListItem() {
                Row() {
                  Image(item.images[0] ? getImageUrl(item.images[0]) : '').width(60).height(60).borderRadius(4).backgroundColor('#eee')
                  Column() {
                    Text(item.title).fontSize(16).maxLines(1)
                    Text(item.content).fontSize(12).fontColor('#999').maxLines(1).margin({top: 4})
                  }.margin({left: 10}).alignItems(HorizontalAlign.Start).layoutWeight(1)
                }.padding(10).width('100%').onClick(() => this.pageStack.pushPath({ name: 'PostDetail', param: new PostParams(item.id) }))
              }
            })
          }.layoutWeight(1)
        }
      }
    }.hideTitleBar(true)
  }
  @Builder TabItem(name: string, index: number) {
    Column() {
      Text(name).fontWeight(this.currentTab === index ? FontWeight.Bold : FontWeight.Normal)
      if (this.currentTab === index) Divider().width(20).strokeWidth(3).color('#FF2442').margin({top: 4})
    }.onClick(() => this.currentTab = index)
  }
}

// EditProfileDialog, PublishView, LoginView ä¿æŒä¸å˜ (å¼•ç”¨ä¸Šä¸€ç‰ˆä»£ç å³å¯)
// ...
// ä¸ºäº†ä»£ç å®Œæ•´æ€§ï¼Œè¿™é‡Œå¿…é¡»åŠ ä¸Š EditProfileDialog, PublishView, LoginView
// è¯·ç›´æ¥å¤åˆ¶ä¸Šä¸€ç‰ˆå›ç­”ä¸­çš„è¿™ä¸‰ä¸ªç»„ä»¶çš„ä»£ç ï¼Œå› ä¸ºå®ƒä»¬é€»è¾‘æ˜¯å®Œå…¨æ­£ç¡®çš„ã€‚
@CustomDialog
struct EditProfileDialog {
  controller: CustomDialogController
  userId: number = 0
  @State nickname: string = ''
  @State age: number = 0
  @State weight: number = 0
  @State tags: string = ''
  confirm: () => void = () => {}

  async save() {
    const params = `user_id=${this.userId}&nickname=${this.nickname}&age=${this.age}&weight=${this.weight}&tags=${this.tags}`;
    await ForumService.updateProfile(params);
    this.confirm();
    this.controller.close();
  }

  async changeAvatar() {
    try {
      const photoPicker = new picker.PhotoViewPicker();
      const result = await photoPicker.select({ MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE, maxSelectNumber: 1 });
      if (result.photoUris.length > 0) {
        promptAction.showToast({message: 'æ­£åœ¨ä¸Šä¼ å¤´åƒ...'});
        const context = getContext(this) as common.UIAbilityContext;
        const file = fs.openSync(result.photoUris[0], fs.OpenMode.READ_ONLY);
        const name = `avatar_${Date.now()}.jpg`;
        const dest = `${context.cacheDir}/${name}`;
        fs.copyFileSync(file.fd, dest);
        fs.closeSync(file);
        const url = await ForumService.uploadImage(context, `internal://cache/${name}`);
        if (url) {
          await ForumService.updateProfile(`user_id=${this.userId}&avatar_url=${url}`);
          promptAction.showToast({message: 'å¤´åƒå·²æ›´æ–°'});
          this.confirm();
        }
      }
    } catch(e) {}
  }

  build() {
    Column({space: 15}) {
      Text("ç¼–è¾‘èµ„æ–™").fontSize(18).fontWeight(FontWeight.Bold)
      Button("ç‚¹å‡»æ›´æ¢å¤´åƒ").fontSize(12).onClick(() => this.changeAvatar())
      TextInput({placeholder: 'æ˜µç§°', text: this.nickname}).onChange(v=>this.nickname=v)
      TextInput({placeholder: 'å¹´é¾„', text: this.age?.toString()}).type(InputType.Number).onChange(v=>this.age=parseInt(v))
      TextInput({placeholder: 'ä½“é‡', text: this.weight?.toString()}).type(InputType.Number).onChange(v=>this.weight=parseFloat(v))
      TextInput({placeholder: 'æ¨èæ ‡ç­¾ (å¦‚: å‡è„‚,ç‘œä¼½)', text: this.tags}).onChange(v=>this.tags=v)
      Row() {
        Button("å–æ¶ˆ").backgroundColor('#eee').fontColor('#333').onClick(() => this.controller.close())
        Blank().width(20)
        Button("ä¿å­˜").backgroundColor('#FF2442').onClick(() => this.save())
      }
    }.padding(20).backgroundColor(Color.White).borderRadius(10)
  }
}

@Component
struct PublishView {
  @Consume('pageStack') pageStack: NavPathStack;
  @State editPostId: number = 0; // 0è¡¨ç¤ºæ–°å»ºï¼Œ>0è¡¨ç¤ºç¼–è¾‘
  @State title: string = '';
  @State content: string = '';
  @State tags: string = '';
  @State uploadedUrls: string[] = [];

  async selectImage() {
    try {
      const photoPicker = new picker.PhotoViewPicker();
      const result = await photoPicker.select({ MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE, maxSelectNumber: 9 });
      if (result.photoUris.length > 0) {
        this.doUploadBatch(result.photoUris);
      }
    } catch (e) {}
  }

  async doUploadBatch(uris: string[]) {
    promptAction.showToast({ message: 'æ­£åœ¨ä¸Šä¼ ...' });
    const context = getContext(this) as common.UIAbilityContext;
    let successCount = 0;
    
    for (const srcUri of uris) {
        try {
          const file = fs.openSync(srcUri, fs.OpenMode.READ_ONLY);
          const name = `pub_${Date.now()}_${Math.random().toString().slice(2,8)}.jpg`;
          const dest = `${context.cacheDir}/${name}`;
          try { fs.unlinkSync(dest); } catch(e) {}
          fs.copyFileSync(file.fd, dest);
          fs.closeSync(file);
          const url = await ForumService.uploadImage(context, `internal://cache/${name}`);
          if (url) {
            this.uploadedUrls.push(url);
            successCount++;
          }
        } catch(e) { console.error("Upload failed", e); }
    }
    
    if (successCount > 0) {
        promptAction.showToast({message:`æˆåŠŸä¸Šä¼  ${successCount} å¼ å›¾ç‰‡`});
    } else {
        promptAction.showToast({message:'ä¸Šä¼ å¤±è´¥'});
    }
  }

  async doPublish() {
    const uid = AppStorage.get<number>('currentUserId');
    // Convert tags string to array string
    const tagArray = this.tags.split(/[,ï¼Œ\s]+/).filter(t => t.trim() !== '');
    const finalTags = JSON.stringify(tagArray);
    
    const finalImg = JSON.stringify(this.uploadedUrls);
    
    let res: ApiResponse<null>;
    if (this.editPostId > 0) {
      // ç¼–è¾‘æ¨¡å¼
      const params = `post_id=${this.editPostId}&user_id=${uid}&title=${this.title}&content=${this.content}&tags=${finalTags}&images=${finalImg}`;
      res = await ForumService.updatePost(params);
    } else {
      // å‘å¸ƒæ¨¡å¼
      const params = `user_id=${uid}&title=${this.title}&content=${this.content}&tags=${finalTags}&images=${finalImg}`;
      res = await ForumService.publish(params);
    }

    if (res.success) {
      promptAction.showToast({message: this.editPostId > 0 ? 'ä¿®æ”¹æˆåŠŸ!' : 'å‘å¸ƒæˆåŠŸ!'});
      AppStorage.setOrCreate('refreshFeed', Date.now()); // è§¦å‘åˆ·æ–°
      this.pageStack.pop();
    } else {
      promptAction.showToast({message: res.message || (this.editPostId > 0 ? 'ä¿®æ”¹å¤±è´¥' : 'å‘å¸ƒå¤±è´¥')});
    }
  }

  build() {
    NavDestination() {
      Column() {
        Row() {
          Text("å–æ¶ˆ").onClick(() => this.pageStack.pop()).fontSize(16).fontColor($r('app.color.text_primary'))
          Blank()
          Button(this.editPostId > 0 ? "ä¿å­˜" : "å‘å¸ƒ").height(32).backgroundColor($r('app.color.brand_red')).fontSize(14).onClick(() => this.doPublish())
        }.padding(15).width('100%')
        TextInput({ placeholder: 'æ ‡é¢˜', text: this.title })
          .fontSize(18).fontWeight(FontWeight.Bold).margin(10)
          .fontColor($r('app.color.text_primary'))
          .backgroundColor($r('app.color.input_bg'))
          .onChange(v=>this.title=v)
        TextArea({ placeholder: 'æ­£æ–‡...', text: this.content })
          .height(100).margin(10)
          .fontColor($r('app.color.text_primary'))
          .backgroundColor(Color.Transparent)
          .onChange(v=>this.content=v)
        TextInput({ placeholder: '#æ ‡ç­¾ (ç”¨ç©ºæ ¼åˆ†éš”)', text: this.tags })
          .margin(10)
          .fontColor($r('app.color.text_primary'))
          .backgroundColor($r('app.color.input_bg'))
          .onChange(v=>this.tags=v)
        
        // Image Grid
        Grid() {
            ForEach(this.uploadedUrls, (img: string, index: number) => {
                GridItem() {
                    Stack({ alignContent: Alignment.TopEnd }) {
                        Image(getImageUrl(img)).width('100%').height(100).borderRadius(8).objectFit(ImageFit.Cover)
                        // Delete button
                        SymbolGlyph($r('sys.symbol.xmark_circle_fill'))
                            .fontSize(24)
                            .fontColor([Color.Red])
                            .backgroundColor($r('app.color.bg_card'))
                            .borderRadius(12)
                            .margin(5)
                            .zIndex(1)
                            .onClick(() => {
                                // Create a new array to ensure UI update
                                let newUrls = [...this.uploadedUrls];
                                newUrls.splice(index, 1);
                                this.uploadedUrls = newUrls;
                            })
                    }
                }
            })
            GridItem() {
                Column() {
                    Image($r('app.media.ic_public_add')).width(30).height(30).fillColor($r('app.color.text_secondary'))
                    Text("æ·»åŠ å›¾ç‰‡").fontSize(12).fontColor($r('app.color.text_secondary')).margin({top:5})
                }
                .width('100%').height(100).backgroundColor('#F5F5F5').borderRadius(8)
                .justifyContent(FlexAlign.Center)
                .onClick(() => this.selectImage())
            }
        }
        .columnsTemplate('1fr 1fr 1fr')
        .columnsGap(10)
        .rowsGap(10)
        .padding(10)
        .height(300)

      }
    }.hideTitleBar(true)
  }
}

@Component
struct LoginView {
  @State username: string = '';
  @State password: string = '';
  async doLogin() {
    const params = `username=${this.username}&password=${this.password}`;
    const res = await ForumService.login(params);
    if (res.success && res.data) {
      AppStorage.setOrCreate('currentUserId', res.data.id);
      promptAction.showToast({message: `æ¬¢è¿ ${res.data.nickname}`});
    } else {
      promptAction.showToast({message: res.message || 'ç™»å½•å¤±è´¥'});
    }
  }
  build() {
    Column({ space: 15 }) {
      Image($r('app.media.app_icon')).width(80).height(80).borderRadius(15).margin({top: 50})
      TextInput({ placeholder: 'ç”¨æˆ·å', text: this.username })
        .width('50%')
        .backgroundColor($r('app.color.input_bg'))
        .fontColor($r('app.color.text_primary'))
        .onChange(v=>this.username=v)
      TextInput({ placeholder: 'å¯†ç ', text: this.password })
        .type(InputType.Password)
        .width('50%')
        .backgroundColor($r('app.color.input_bg'))
        .fontColor($r('app.color.text_primary'))
        .onChange(v=>this.password=v)
      Button("ç™»å½• / æ³¨å†Œ").width('35%').height(45).backgroundColor($r('app.color.brand_red')).margin({top: 20}).onClick(() => this.doLogin())
    }.width('100%').height('100%').backgroundColor($r('app.color.page_bg'))
  }
}

@Component
struct SearchPage {
  @Consume('pageStack') pageStack: NavPathStack;
  @State keyword: string = '';
  @State searchResults: ForumPost[] = [];
  @State isLoading: boolean = false;

  aboutToAppear() {
    if (this.keyword) {
      this.doSearch();
    }
  }

  async doSearch() {
    this.isLoading = true;
    const res = await ForumService.getFeed(this.keyword);
    if (res.success && res.data) {
      // Parse images and tags
      this.searchResults = res.data.map(item => {
        if (typeof item.images === 'string') {
            try { item.images = JSON.parse(item.images); } catch(e) { item.images = []; }
        }
        if (typeof item.tags === 'string') {
            try { item.tags = JSON.parse(item.tags); } catch(e) { item.tags = []; }
        }
        return item;
      });
    } else {
      this.searchResults = [];
    }
    this.isLoading = false;
  }

  build() {
    NavDestination() {
      Column() {
        // Search Bar
        Row() {
          SymbolGlyph($r('sys.symbol.chevron_left'))
            .fontSize(24)
            .margin({right: 10})
            .onClick(() => this.pageStack.pop())
          TextInput({ placeholder: 'æœç´¢...', text: this.keyword })
            .layoutWeight(1)
            .height(40)
            .onChange((value) => {
              this.keyword = value;
            })
            .onSubmit(() => {
              this.doSearch();
            })
          Button("æœç´¢")
            .margin({left: 10})
            .height(30)
            .fontSize(14)
            .onClick(() => this.doSearch())
        }.padding(10).width('100%').backgroundColor($r('app.color.page_bg'))

        if (this.isLoading) {
          LoadingProgress().width(50).height(50).margin({top: 50})
        } else if (this.searchResults.length === 0) {
          Text("æš‚æ— ç›¸å…³å†…å®¹").margin({top: 50}).fontColor($r('app.color.text_secondary'))
        } else {
          List({ space: 10 }) {
            ForEach(this.searchResults, (item: ForumPost) => {
              ListItem() {
                Row() {
                  Image(getImageUrl(item.images && item.images.length > 0 ? item.images[0] : ''))
                    .width(100).height(100).borderRadius(8).objectFit(ImageFit.Cover).backgroundColor($r('app.color.input_bg'))
                  Column() {
                    Text(item.title).fontSize(16).fontWeight(FontWeight.Bold).maxLines(1).textOverflow({overflow: TextOverflow.Ellipsis}).fontColor($r('app.color.text_primary'))
                    Text(item.content).fontSize(14).fontColor($r('app.color.text_secondary')).maxLines(2).textOverflow({overflow: TextOverflow.Ellipsis}).margin({top: 5})
                    Row() {
                      Image(item.author_avatar ? `${DOMAIN}${item.author_avatar}` : $r('app.media.app_icon'))
                        .width(20).height(20).borderRadius(10)
                      Text(item.author_name).fontSize(12).fontColor($r('app.color.text_secondary')).margin({left: 5})
                      Blank()
                      SymbolGlyph($r('sys.symbol.heart')).fontSize(14).fontColor([$r('app.color.text_secondary')])
                      Text(item.like_count.toString()).fontSize(12).fontColor($r('app.color.text_secondary')).margin({left: 2})
                    }.width('100%').margin({top: 10})
                  }.layoutWeight(1).height(100).padding({left: 10}).justifyContent(FlexAlign.SpaceBetween).alignItems(HorizontalAlign.Start)
                }
                .width('100%').padding(10).backgroundColor(Color.White).borderRadius(8)
                .onClick(() => {
                  this.pageStack.pushPath({ name: 'PostDetail', param: new PostParams(item.id) });
                })
              }
            })
          }.layoutWeight(1).width('100%').padding(10)
        }
      }.height('100%').backgroundColor('#F5F5F5')
    }.hideTitleBar(true)
  }
}