// æ–‡ä»¶è·¯å¾„: features/forum/src/main/ets/service/ForumService.ets
import { http } from '@kit.NetworkKit';
import { request } from '@kit.BasicServicesKit';
import { common } from '@kit.AbilityKit';
import { fileIo as fs } from '@kit.CoreFileKit';
import { ApiResponse } from '../model/ForumModel';

// ğŸ”´ è¯·å†æ¬¡ç¡®è®¤è¿™ä¸ª IP æ˜¯å¯¹çš„ï¼
const BASE_URL = 'http://172.26.117.216:8000';

interface UploadData {
  url?: string;
}

interface UploadResponse {
  url?: string;
  img_url?: string;
  data?: UploadData;
}

export class ForumService {

  // é€šç”¨è¯·æ±‚æ ¸å¿ƒ
  private static async request<T>(url: string, method: http.RequestMethod, extraData?: Object): Promise<ApiResponse<T>> {
    const req = http.createHttp();
    let fullUrl = `${BASE_URL}${url}`;

    // è‡ªåŠ¨è¿½åŠ  user_id
    if (method === http.RequestMethod.GET && AppStorage.get('currentUserId')) {
      fullUrl += (url.includes('?') ? '&' : '?') + `user_id=${AppStorage.get('currentUserId')}`;
    }

    try {
      console.info(`[ForumService] Requesting: ${fullUrl}, Method: ${method}`); // ğŸ” è°ƒè¯•æ—¥å¿—

      const result = await req.request(fullUrl, {
        method: method,
        header: { 'Content-Type': 'application/x-www-form-urlencoded' },
        extraData: extraData,
        expectDataType: http.HttpDataType.OBJECT
      });

      console.info(`[ForumService] Response Code: ${result.responseCode}`); // ğŸ” è°ƒè¯•æ—¥å¿—

      if (result.responseCode !== 200) {
        return { success: false, message: `æœåŠ¡å™¨é”™è¯¯: ${result.responseCode}` };
      }

      return result.result as ApiResponse<T>;
    } catch (e) {
      console.error(`[ForumService] Error: ${JSON.stringify(e)}`); // ğŸ” å…³é”®æŠ¥é”™ä¿¡æ¯
      return { success: false, message: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ IP' };
    } finally {
      req.destroy();
    }
  }

  // === ä¸šåŠ¡æ¥å£ ===
  static async getFeed(keyword: string = ""): Promise<ApiResponse<import('../model/ForumModel').ForumPost[]>> {
    return ForumService.request(`/api/feed?keyword=${keyword}`, http.RequestMethod.GET);
  }
  static async login(params: string): Promise<ApiResponse<import('../model/ForumModel').UserInfo>> {
    return ForumService.request('/api/login', http.RequestMethod.POST, params);
  }
  static async getPostDetail(postId: number): Promise<ApiResponse<import('../model/ForumModel').PostDetailData>> {
    return ForumService.request(`/api/post/${postId}`, http.RequestMethod.GET);
  }
  static async publish(params: string): Promise<ApiResponse<null>> {
    return ForumService.request('/api/publish', http.RequestMethod.POST, params);
  }
  static async getProfile(targetId: number): Promise<ApiResponse<import('../model/ForumModel').ProfileData>> {
    return ForumService.request(`/api/user/profile?target_id=${targetId}`, http.RequestMethod.GET);
  }
  static async likePost(postId: number, userId: number): Promise<ApiResponse<null>> {
    return ForumService.request('/api/like', http.RequestMethod.POST, `user_id=${userId}&post_id=${postId}`);
  }
  static async favPost(postId: number, userId: number): Promise<ApiResponse<null>> {
    return ForumService.request('/api/fav', http.RequestMethod.POST, `user_id=${userId}&post_id=${postId}`);
  }
  static async sendComment(userId: number, postId: number, content: string): Promise<ApiResponse<null>> {
    return ForumService.request('/api/comment', http.RequestMethod.POST, `user_id=${userId}&post_id=${postId}&content=${content}`);
  }
  static async updateProfile(params: string): Promise<ApiResponse<import('../model/ForumModel').UserInfo>> {
    return ForumService.request('/api/user/update', http.RequestMethod.POST, params);
  }

  // å›¾ç‰‡ä¸Šä¼  (ä¿®å¤ç‰ˆï¼šä½¿ç”¨ http æ›¿ä»£ request.uploadFile ä»¥è·å–å“åº”ä½“)
  static async uploadImage(context: common.UIAbilityContext, fileUri: string): Promise<string> {
    try {
      // 1. å¤„ç†è·¯å¾„: å°† internal://cache/ è½¬ä¸ºç»å¯¹è·¯å¾„
      let realPath = fileUri;
      if (realPath.startsWith('internal://cache/')) {
        realPath = context.cacheDir + '/' + realPath.substring('internal://cache/'.length);
      }

      // 2. è¯»å–æ–‡ä»¶
      const file = fs.openSync(realPath, fs.OpenMode.READ_ONLY);
      const stat = fs.statSync(realPath);
      const fileBuffer = new ArrayBuffer(stat.size);
      fs.readSync(file.fd, fileBuffer);
      fs.closeSync(file);

      // 3. æ„å»º Multipart è¯·æ±‚ä½“
      const boundary = '----WebKitFormBoundary' + new Date().getTime();
      const req = http.createHttp();

      const headerStr = `--${boundary}\r\nContent-Disposition: form-data; name="file"; filename="upload.jpg"\r\nContent-Type: image/jpeg\r\n\r\n`;
      const footerStr = `\r\n--${boundary}--`;

      // å­—ç¬¦ä¸²è½¬ Uint8Array è¾…åŠ©å‡½æ•°
      const strToBuf = (s: string) => {
        const buf = new Uint8Array(s.length);
        for (let i = 0; i < s.length; i++) {
          buf[i] = s.charCodeAt(i);
        }
        return buf;
      };

      const headerArr = strToBuf(headerStr);
      const footerArr = strToBuf(footerStr);
      const fileArr = new Uint8Array(fileBuffer);

      const totalLen = headerArr.length + fileArr.length + footerArr.length;
      const fullBuf = new Uint8Array(totalLen);
      fullBuf.set(headerArr, 0);
      fullBuf.set(fileArr, headerArr.length);
      fullBuf.set(footerArr, headerArr.length + fileArr.length);

      // 4. å‘é€è¯·æ±‚
      const result = await req.request(`${BASE_URL}/api/upload`, {
        method: http.RequestMethod.POST,
        header: {
          'Content-Type': `multipart/form-data; boundary=${boundary}`
        },
        extraData: fullBuf.buffer
      });

      // 5. è§£æå“åº”
      if (result.responseCode === 200) {
        const resStr = result.result ? result.result.toString() : '';
        console.info(`[ForumService] Upload Response Raw: ${resStr}`);

        // 1. å°è¯• JSON è§£æ
        try {
          const resJson = JSON.parse(resStr) as UploadResponse;
          if (resJson.url) return resJson.url;
          if (resJson.data && resJson.data.url) return resJson.data.url;
          if (resJson.img_url) return resJson.img_url;
        } catch (e) {
          // å¿½ç•¥ JSON é”™è¯¯
        }

        // 2. å°è¯•ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸² (å®½å®¹æ¨¡å¼)
        // åªè¦ä¸æ˜¯ç©ºçš„ï¼Œä¸”ä¸åŒ…å«é”™è¯¯ä¿¡æ¯ï¼Œå°±è®¤ä¸ºæ˜¯è·¯å¾„
        if (resStr && resStr.length > 0 && !resStr.includes('error') && !resStr.includes('Error')) {
          // æ¸…ç†å¼•å·ï¼ˆæœ‰äº›åç«¯ç›´æ¥è¿”å›å¸¦å¼•å·çš„å­—ç¬¦ä¸² "path"ï¼‰
          let cleanStr = resStr.replace(/^"|"$/g, '').trim();
          // å¦‚æœè¿”å›çš„æ˜¯çº¯æ–‡ä»¶åï¼Œå°è¯•è¡¥å…¨è·¯å¾„ï¼ˆå‡è®¾åç«¯å­˜æ”¾åœ¨ uploads/ ä¸‹ï¼‰
          if (!cleanStr.includes('/') && !cleanStr.startsWith('http')) {
             cleanStr = `/uploads/${cleanStr}`;
          }
          return cleanStr;
        }

        // 3. Header å…œåº• (å…¼å®¹æ—§é€»è¾‘)
        if (result.header) {
          // æŸ¥æ‰¾ img-url (å¿½ç•¥å¤§å°å†™)
          const key = Object.keys(result.header).find(k => k.toLowerCase() === 'img-url');
          if (key) return result.header[key].toString();
        }
      } else {
        console.error(`[ForumService] Upload Failed Code: ${result.responseCode}`);
      }
    } catch (e) {
      console.error(`[ForumService] Upload Failed: ${JSON.stringify(e)}`);
    }
    return '';
  }
}